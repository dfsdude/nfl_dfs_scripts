# sims_tool.py Review Notes

- **Consolidate payout parsing**: The payout parsing logic is duplicated across Double-Up/50-50 presets, Flat GPP, Top-Heavy GPP, and Custom inputs. Extracting a single helper (e.g., `parse_payout_input(payout_input, field_size, entry_fee, multiplier=None)`) would reduce maintenance overhead and ensure consistent error handling for all contest types. The repeated blocks between lines 52-152 are nearly identical aside from preset text and multipliers, making them good candidates for refactoring. 【F:sims_tool.py†L52-L152】
- **Cache expensive preprocessing**: Loading CSVs, building `player_hist`, computing matchup z-scores, and constructing `team_env` all happen inside the main execution path and rerun whenever a widget changes. Wrapping these steps in `st.cache_data` / `st.cache_resource` would avoid recomputation while exploring sidebar controls, leading to faster iteration. Heavy sections include the player history build and matchup environment assembly starting around the data-loading block. 【F:sims_tool.py†L177-L331】【F:sims_tool.py†L400-L458】
- **Validate optional team stats columns**: When optional team offense/defense files are provided, the code accesses columns like `Avg Pass Att`, `Avg Rush Att`, and `Avg_Rush_TD` directly. If a user uploads a file missing any of these exact headers, the app will raise a KeyError before the `try` block’s generic handler. Adding explicit column checks (similar to required CSV validations) would produce clearer user errors and prevent runtime failures. 【F:sims_tool.py†L300-L347】
- **Guard `find_column` matches**: The helper returns the first column containing a substring, which could accidentally match unrelated headers (e.g., `Opponent Name` when looking for `Name`). Tightening matches (exact case-insensitive equality or prioritized lists) would make column detection more predictable and reduce false positives when users supply wide CSVs. 【F:sims_tool.py†L168-L176】
